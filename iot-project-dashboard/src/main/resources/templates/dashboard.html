<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Cooking - Dashboard Overview</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
</head>
<body>
    <div class="dashboard-layout">
        <!-- Side Menu -->
        <aside class="sidebar-nav">
            <div class="sidebar-header">
                <i class="fas fa-utensils"></i>
                <h1>Smart Cooking</h1>
                <p class="sidebar-team">Team XCV</p>
            </div>
            <nav class="sidebar-nav-menu">
                <a class="sidebar-nav-item sidebar-nav-item-active" href="/dashboard">
                    <i class="fas fa-tachometer-alt sidebar-nav-icon"></i>
                    <span class="sidebar-nav-text">Dashboard</span>
                </a>
                <a class="sidebar-nav-item" href="/sessions">
                    <i class="fas fa-fire sidebar-nav-icon"></i>
                    <span class="sidebar-nav-text">Cooking Sessions</span>
                </a>
                <a class="sidebar-nav-item" href="/about">
                    <i class="fas fa-info-circle sidebar-nav-icon"></i>
                    <span class="sidebar-nav-text">About Us</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="dashboard-main-content">
            <div class="container mt-4">
                <div class="row">
                    <div class="col-12">
                        <h1 class="h2 mb-4">
                            <i class="fas fa-tachometer-alt me-2"></i>
                            Dashboard Overview
                        </h1>

                        <!-- Statistics Cards - Separated Columns -->
                        <div class="row mb-4" th:if="${totalSessions != null and totalSessions > 0}">
                            <!-- Total Sessions Card -->
                            <div class="col-lg-4 col-md-6 mb-3">
                                <div class="overview-stat-card shadow-sm h-100">
                                    <div class="overview-stat-icon-wrapper bg-primary-light">
                                        <i class="fas fa-calendar-alt overview-stat-icon text-primary"></i>
                                    </div>
                                    <div class="overview-stat-content">
                                        <h2 class="overview-stat-number" th:text="${totalSessions}">0</h2>
                                        <p class="overview-stat-label">Total Sessions</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Cooking Styles Card -->
                            <div class="col-lg-4 col-md-6 mb-3">
                                <div class="overview-stat-card shadow-sm h-100">
                                    <div class="overview-stat-icon-wrapper bg-danger-light">
                                        <i class="fas fa-fire overview-stat-icon text-danger"></i>
                                    </div>
                                    <div class="overview-stat-content">
                                        <h2 class="overview-stat-number" th:text="${#lists.size(allCookingStyles)}">0</h2>
                                        <p class="overview-stat-label mb-2">Cooking Styles</p>
                                        <div class="overview-badge-container">
                                            <span class="badge bg-secondary me-1 mb-1" th:each="style : ${allCookingStyles}" th:text="${style}">Style</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Unique Ingredients Card -->
                            <div class="col-lg-4 col-md-6 mb-3">
                                <div class="overview-stat-card shadow-sm h-100">
                                    <div class="overview-stat-icon-wrapper bg-success-light">
                                        <i class="fas fa-leaf overview-stat-icon text-success"></i>
                                    </div>
                                    <div class="overview-stat-content">
                                        <h2 class="overview-stat-number" th:text="${#lists.size(allIngredients)}">0</h2>
                                        <p class="overview-stat-label mb-2">Unique Ingredients</p>
                                        <div class="overview-badge-container scrollable">
                                            <span class="badge rounded-pill bg-light text-dark border me-1 mb-1" th:each="ingredient : ${allIngredients}" th:text="${ingredient}">Ingredient</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Cooking Activity Timeline -->
                        <div class="row mb-4" th:if="${totalSessions != null and totalSessions > 0}">
                            <div class="col-12">
                                <div class="card shadow-sm">
                                    <div class="card-body">
                                        <h5 class="card-title mb-4">
                                            <i class="fas fa-history me-2"></i>
                                            Cooking Activity Timeline
                                        </h5>
                                        <div class="cooking-timeline-container">
                                            <div class="cooking-timeline">
                                                <div class="timeline-line"></div>
                                                <div th:each="monthEntry, monthStat : ${sessionsByMonth}" class="timeline-month-group">
                                                    <div class="timeline-month-header" th:classappend="${monthStat.index % 2 == 0} ? 'timeline-month-even' : 'timeline-month-odd'">
                                                        <span th:text="${monthEntry.key}">Month Year</span>
                                                        <span class="timeline-month-count" th:text="${'(' + #lists.size(monthEntry.value) + ')'}">(0)</span>
                                                    </div>
                                                    <div class="timeline-month-sessions">
                                                        <div th:each="cookingSession : ${monthEntry.value}" class="timeline-items">
                                                            <a th:href="@{/sessions(sessionNumber=${cookingSession.sessionNumber})}"
                                                               th:class="${(sessionIndexMap.get(cookingSession) % 2 == 0) ? 'timeline-item timeline-item-top' : 'timeline-item timeline-item-bottom'}"
                                                               th:title="${cookingSession.dishDescription}">
                                                                <div class="timeline-dot"
                                                                     th:classappend="${monthStat.index % 2 == 0} ? 'timeline-dot-even' : 'timeline-dot-odd'">
                                                                    <i class="fas fa-utensils"></i>
                                                                </div>
                                                                <div class="timeline-content"
                                                                     th:attr="data-image-url=${cookingSession.imageUrl}"
                                                                     th:classappend="${monthStat.index % 2 == 0} ? 'timeline-content-even' : 'timeline-content-odd'">
                                                                    <div class="timeline-session-number"
                                                                         th:classappend="${monthStat.index % 2 == 0} ? 'timeline-session-number-even' : 'timeline-session-number-odd'">
                                                                        <span th:text="${cookingSession.sessionNumber}">Session</span>
                                                                    </div>
                                                                    <div class="timeline-ingredients" th:attr="data-ingredients=${cookingSession.ingredients}">
                                                                        <!-- Ingredients will be populated by JavaScript -->
                                                                    </div>
                                                                    <div class="timeline-datetime-compact">
                                                                        <span th:text="${#temporals.format(cookingSession.dateTime, 'MMM dd')}">Date</span>
                                                                    </div>
                                                                </div>
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Charts Section -->
                        <div class="row" th:if="${totalSessions != null and totalSessions > 0}">
                            <!-- Cooking Styles Chart -->
                            <div class="col-lg-6 mb-4">
                                <div class="card shadow-sm h-100">
                                    <div class="card-body">
                                        <h5 class="card-title mb-3">
                                            <i class="fas fa-fire text-danger me-2"></i>
                                            Most Used Cooking Styles
                                        </h5>
                                        <div class="chart-container">
                                            <canvas id="cookingStylesChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Ingredients Chart -->
                            <div class="col-lg-6 mb-4">
                                <div class="card shadow-sm h-100">
                                    <div class="card-body">
                                        <h5 class="card-title mb-3">
                                            <i class="fas fa-leaf text-success me-2"></i>
                                            Most Used Ingredients
                                        </h5>
                                        <div class="chart-container">
                                            <canvas id="ingredientsChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row" th:if="${totalSessions == null or totalSessions == 0}">
                            <div class="col-12">
                                <div class="text-center py-5">
                                    <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                                    <h3 class="text-muted">No Data Available</h3>
                                    <p class="text-muted">Start cooking to see your statistics here!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script th:inline="javascript">
        // Timeline Ingredients Processing
        function getIngredientEmoji(ingredient) {
            const lower = ingredient.toLowerCase().trim();
            const emojiMap = {
                'chicken': '🍗', 'beef': '🥩', 'pork': '🥓', 'fish': '🐟', 'salmon': '🐟',
                'shrimp': '🦐', 'egg': '🥚', 'cheese': '🧀', 'milk': '🥛', 'butter': '🧈',
                'rice': '🍚', 'pasta': '🍝', 'bread': '🍞', 'potato': '🥔', 'tomato': '🍅',
                'onion': '🧅', 'garlic': '🧄', 'carrot': '🥕', 'broccoli': '🥦', 'pepper': '🌶️',
                'mushroom': '🍄', 'corn': '🌽', 'lettuce': '🥬', 'spinach': '🥬', 'cucumber': '🥒',
                'apple': '🍎', 'banana': '🍌', 'lemon': '🍋', 'strawberry': '🍓', 'orange': '🍊',
                'salt': '🧂', 'sugar': '🍬', 'oil': '🫗', 'soy sauce': '🥫', 'vinegar': '🫙'
            };
            return emojiMap[lower] || '🥘';
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Set background images (no dark overlay)
            document.querySelectorAll('.timeline-content').forEach(function(content) {
                const imageUrl = content.getAttribute('data-image-url');
                if (imageUrl) {
                    content.style.backgroundImage = 'url(\'' + imageUrl + '\')';
                }
            });

            // Format dates to show only date (no time)
            document.querySelectorAll('.timeline-datetime-compact span').forEach(function(dateSpan) {
                const dateTimeStr = dateSpan.textContent.trim();
                if (dateTimeStr && dateTimeStr !== 'Date') {
                    try {
                        const dateOnly = dateTimeStr.split('T')[0];
                        dateSpan.textContent = dateOnly;
                    } catch (e) {
                        console.log('Could not parse date:', dateTimeStr);
                    }
                }
            });

            // Set ingredients
            document.querySelectorAll('.timeline-ingredients').forEach(function(container) {
                const ingredientsStr = container.getAttribute('data-ingredients');
                if (ingredientsStr) {
                    const cleanIngredients = ingredientsStr.replace(/[{}]/g, '');
                    const ingredientList = cleanIngredients.split(',').map(i => i.trim()).filter(i => i);

                    let html = '';
                    if (ingredientList.length <= 2) {
                        ingredientList.forEach(ing => {
                            html += '<span class="ingredient-emoji">' + getIngredientEmoji(ing) + '</span>';
                        });
                    } else {
                        html += '<span class="ingredient-emoji">' + getIngredientEmoji(ingredientList[0]) + '</span>';
                        html += '<span class="ingredient-emoji">' + getIngredientEmoji(ingredientList[1]) + '</span>';
                        html += '<span class="ingredient-count">+' + (ingredientList.length - 2) + '</span>';
                    }
                    container.innerHTML = html;
                }
            });
        });

        // Cooking Styles Data
        var cookingStyleLabels = [[${allCookingStyles}]];
        var cookingStyleCountsObj = [[${cookingStyleCounts}]];
        var cookingStyleData = cookingStyleLabels.map(function(style) {
            return cookingStyleCountsObj[style] || 0;
        });

        console.log('Cooking Styles:', cookingStyleLabels);
        console.log('Cooking Style Counts:', cookingStyleCountsObj);
        console.log('Cooking Style Data:', cookingStyleData);

        // Ingredients Data (top 10)
        var allIngredientsList = [[${allIngredients}]];
        var ingredientCountsMap = [[${ingredientCounts}]];
        var topIngredients = allIngredientsList.slice(0, 10);
        var ingredientData = topIngredients.map(function(ingredient) {
            return ingredientCountsMap[ingredient] || 0;
        });

        console.log('Top Ingredients:', topIngredients);
        console.log('Ingredient Counts Map:', ingredientCountsMap);
        console.log('Ingredient Data:', ingredientData);

        // Color palettes
        const cookingStyleColors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
            '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
        ];

        const ingredientColors = [
            '#27ae60', '#2ecc71', '#3498db', '#9b59b6', '#e74c3c',
            '#f39c12', '#1abc9c', '#34495e', '#16a085', '#d35400'
        ];

        // Cooking Styles Chart
        if (cookingStyleLabels.length > 0) {
            const ctxStyles = document.getElementById('cookingStylesChart');
            new Chart(ctxStyles, {
                type: 'bar',
                data: {
                    labels: cookingStyleLabels,
                    datasets: [{
                        label: 'Number of Sessions',
                        data: cookingStyleData,
                        backgroundColor: cookingStyleColors.slice(0, cookingStyleLabels.length),
                        borderColor: cookingStyleColors.slice(0, cookingStyleLabels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Sessions: ' + context.parsed.y;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Number of Sessions'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Cooking Style'
                            }
                        }
                    }
                }
            });
        }

        // Ingredients Chart
        if (topIngredients.length > 0) {
            const ctxIngredients = document.getElementById('ingredientsChart');
            new Chart(ctxIngredients, {
                type: 'bar',
                data: {
                    labels: topIngredients,
                    datasets: [{
                        label: 'Usage Count',
                        data: ingredientData,
                        backgroundColor: ingredientColors.slice(0, topIngredients.length),
                        borderColor: ingredientColors.slice(0, topIngredients.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Used in: ' + context.parsed.x + ' session(s)';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Number of Uses'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Ingredient'
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>

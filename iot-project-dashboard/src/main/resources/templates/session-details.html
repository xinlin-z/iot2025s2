<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Details - IoT Cooking Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">
                <i class="fas fa-utensils me-2"></i>
                IoT Cooking Monitor
            </a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
                        <li class="breadcrumb-item active">Session Details</li>
                    </ol>
                </nav>

                <div class="card shadow-sm" th:if="${session != null}">
                    <div class="row g-0">
                        <div class="col-md-4">
                            <img class="img-fluid rounded-start h-100"
                                 th:src="@{${session.thumbnailImagePath}}"
                                 th:alt="${session.dishDescription}"
                                 style="object-fit: cover; min-height: 300px;"
                                 onerror="this.src='https://via.placeholder.com/400x300/6c757d/ffffff?text=Cooking+Session'">
                        </div>
                        <div class="col-md-8">
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h2 class="card-title" th:text="${session.dishDescription}">Dish Description</h2>
                                    <span class="badge bg-primary fs-6">Session #<span th:text="${session.sessionNumber}">0</span></span>
                                </div>

                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <h5><i class="fas fa-clock text-primary me-2"></i>Session Details</h5>
                                        <p><strong>Date & Time:</strong><br>
                                           <span th:text="${#temporals.format(session.dateTime, 'EEEE, MMMM dd, yyyy')}">Date</span><br>
                                           <span th:text="${#temporals.format(session.dateTime, 'HH:mm')}">Time</span></p>

                                        <p><strong>Cooking Style:</strong><br>
                                           <span class="badge bg-secondary fs-6" th:text="${session.cookingStyle}">Style</span></p>

                                        <div th:if="${session.durationMinutes != null}">
                                            <p><strong>Duration:</strong><br>
                                               <i class="fas fa-stopwatch me-1"></i><span th:text="${session.durationMinutes}">0</span> minutes</p>
                                        </div>

                                        <div th:if="${session.temperatureAvg != null}">
                                            <p><strong>Average Temperature:</strong><br>
                                               <i class="fas fa-thermometer-half me-1"></i><span th:text="${session.temperatureAvg}">0</span>Â°C</p>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <h5><i class="fas fa-leaf text-success me-2"></i>Ingredients Used</h5>
                                        <p class="text-muted" th:text="${session.ingredients}">Ingredients list</p>
                                    </div>
                                </div>

                                <div class="d-flex gap-2">
                                    <a href="/dashboard" class="btn btn-outline-secondary">
                                        <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-warning" th:if="${session == null}">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Session not found. <a href="/dashboard">Return to Dashboard</a>
                </div>

                <!-- Cook Presence Timeline -->
                <div class="card shadow-sm mt-4" th:if="${session != null}">
                    <div class="card-body">
                        <h4 class="card-title mb-3">
                            <i class="fas fa-user-clock text-info me-2"></i>Cook Presence Timeline
                        </h4>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="alert alert-info mb-0">
                                    <h5 class="mb-1">Presence Percentage</h5>
                                    <h2 class="mb-0" id="presencePercentage">
                                        <i class="fas fa-spinner fa-spin"></i> Loading...
                                    </h2>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-secondary mb-0">
                                    <p class="mb-1"><strong>Total Present:</strong> <span id="totalPresent">-</span></p>
                                    <p class="mb-0"><strong>Total Away:</strong> <span id="totalAway">-</span></p>
                                </div>
                            </div>
                        </div>
                        <canvas id="presenceChart" height="80"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:if="${session != null}" th:inline="javascript">
        const sessionNumber = /*[[${session.sessionNumber}]]*/ 0;

        // Fetch motion data and create timeline
        fetch(`/dashboard/api/motion/${sessionNumber}`)
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    document.getElementById('presencePercentage').innerHTML = 'No data available';
                    return;
                }

                // Process data for timeline
                const labels = [];
                const presenceData = [];
                let totalPresent = 0;
                let totalAway = 0;

                data.forEach(point => {
                    const datetime = new Date(point.datetime);
                    labels.push(datetime.toLocaleTimeString());
                    presenceData.push(point.value ? 1 : 0); // 1 for present, 0 for away

                    if (point.value) {
                        totalPresent++;
                    } else {
                        totalAway++;
                    }
                });

                // Calculate percentage
                const totalReadings = totalPresent + totalAway;
                const percentage = totalReadings > 0 ? ((totalPresent / totalReadings) * 100).toFixed(1) : 0;

                // Update stats
                document.getElementById('presencePercentage').innerHTML = `${percentage}%`;
                document.getElementById('totalPresent').textContent = `${totalPresent} readings`;
                document.getElementById('totalAway').textContent = `${totalAway} readings`;

                // Create timeline chart
                const ctx = document.getElementById('presenceChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Cook Presence',
                            data: presenceData,
                            backgroundColor: 'rgba(23, 162, 184, 0.2)',
                            borderColor: 'rgba(23, 162, 184, 1)',
                            borderWidth: 2,
                            stepped: true,
                            fill: true,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 1,
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        return value === 1 ? 'Present' : 'Away';
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    maxTicksLimit: 20
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.parsed.y === 1 ? 'Present' : 'Away';
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching motion data:', error);
                document.getElementById('presencePercentage').innerHTML = 'Error loading data';
            });
    </script>
</body>
</html>